<!DOCTYPE HTML>
<html>
  <head>
    <style>
      *{ padding: 0; margin: 0 }
      body { background-color: black; }
      #container { display: flex; width: 100vw; height: 100vh; align-items: center; justify-content: center; flex-direction: column; }
      canvas{ border: 1px solid #eee; }
      button { padding: 10px 20px; margin: 10px }
      .hbtn { color: red }
    </style>
    <script>
      const TYPES = {
        BLOCK: 1,
        SAND: 2,
        WATER: 3
      }

      const MOVES = {
        [TYPES.BLOCK]: [
          { dx: 0, dy: 1 }
        ],
        [TYPES.SAND]: [
          { dx: 0, dy: 1 },
          { dx: -1, dy: 1 },
          { dx: 1, dy: 1 },
        ],
        [TYPES.WATER]: [
          { dx: 0, dy: 1 },
          { dx: -1, dy: 1 },
          { dx: 1, dy: 1 },
          { dx: -1, dy: 0 },
          { dx: 1, dy: 0 },
        ]
      }

      const NAMES = {
        [TYPES.BLOCK]: 'GẠCH',
        [TYPES.SAND]: 'CÁT',
        [TYPES.WATER]: 'NƯỚC'
      }

      const COLORS = {
        [TYPES.BLOCK]: 'white',
        [TYPES.SAND]: '#ffffc6',
        [TYPES.WATER]: '#0863de'
      }

      window.type = TYPES.BLOCK

      const resetButtonClass = () => {
        const buttons = document.getElementsByTagName('button')
        for(const btn of buttons) {
          btn.className = ''
        }
      }
    </script>
  </head>
  <body>
    <div id="container">
      <canvas width="1024px" height="1024px">
      </canvas>
      <br />
      <div style="display: flex;">
        <script>
          for(const t of Object.values(TYPES)) {
            document.writeln(`
              <button onclick="resetButtonClass(); this.className = 'hbtn'; window.type = ${t}" style="background-color: ${COLORS[t]};">${NAMES[t]}</button>
            `)
          }
        </script>
      </div>
    </div>
    <script>
      const SIZE = 1024
      const ELEMENT = 32
      const EDGE = SIZE / ELEMENT

      const canvas = document.querySelector("canvas"); 
      const cv = canvas.getContext('2d');

      let isMouseDown = false

      const world = []
      for(let i = 0; i < ELEMENT; i++) {
        world.push([...Array(ELEMENT)].map(item => 0))
      }

      const getMousePos = (canvas, evt) => {
        var rect = canvas.getBoundingClientRect();
        return {
          x: evt.clientX - rect.left,
          y: evt.clientY - rect.top
        };
      }

      const isAvailable = (x, y) => {
        return x >= 0 && y >= 0 && x < ELEMENT && y < ELEMENT && !world[y][x]
      }

      const swap = (x0, y0, x1, y1) => {
        const tmp = world[y0][x0]
        world[y0][x0] = world[y1][x1]
        world[y1][x1] = tmp
      }

      const handleAdd = (e) => {
        const pos = getMousePos(canvas, e)

        const x = Math.floor(pos.x / EDGE)
        const y = Math.floor(pos.y / EDGE)

        if(!world[y][x]) {
          world[y][x] = type
        }
      }

      canvas.onmousemove = e => {
        if(isMouseDown) {
          handleAdd(e)
        }
      }
      canvas.onmousedown = e => {
        handleAdd(e)
        isMouseDown = true
      }
      canvas.onmouseup = e => {
        isMouseDown = false
      }

      const update = () => {
        for(let y = ELEMENT - 1; y >= 0; y--) {
          for(let x = 0; x < ELEMENT; x++) {
            if(world[y][x]) {
              for(const move of MOVES[world[y][x]]) {
                const ty = y + move.dy
                const tx = x + move.dx

                if(isAvailable(tx, ty)) {
                  swap(x, y, tx, ty)
                  break
                }
              }
            }
          }
        }
      }

      const move = () => {
        requestAnimationFrame(move);
        update()
        cv.clearRect(0, 0, SIZE, SIZE);

        cv.strokeStyle = "white"
        for(let y = 0; y < ELEMENT; y++) {
          cv.moveTo(0, y * EDGE);
          cv.lineTo(SIZE, y * EDGE);
          cv.stroke();

          cv.moveTo(y * EDGE, 0 );
          cv.lineTo(y * EDGE, SIZE);
          cv.stroke();
        }

        for(let y = 0; y < ELEMENT; y++) {
          for(let x = 0; x < ELEMENT; x++) {

            if(world[y][x]) {
              cv.beginPath();
              cv.fillStyle = COLORS[world[y][x]]
              cv.fillRect(x * EDGE, y * EDGE, EDGE, EDGE);
            }
          }
        }
      }

      move();
    </script>
  </body>
</html>